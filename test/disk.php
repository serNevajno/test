<?php
//error_reporting(0);
include ($_SERVER['DOCUMENT_ROOT'].'/inc/db.inc.php');
include($_SERVER['DOCUMENT_ROOT'] . '/adminius/inc/function.inc.php');
mysql_query('SET NAMES cp1251');
$result = db2array("SELECT t2.id, t2.name, t2.article FROM filter_value as t1 LEFT JOIN product as t2 on (t1.id_product=t2.id) WHERE t1.element_value='0' AND t1.id_filter='27' AND t2.categories!='28' ", 2);
$i = 0;
/*echo "<pre>";
print_r($result);
echo "</pre>";*/
$arr = array();
$arr += array($i => array(
    "article" => "Артикул",
    "id" => "ID",
    "name" => "Название товара",
    "fil" => "Сверловке"
));

foreach ($arr[0] as $key => $string) {
    $arr[0][$key] = iconv("utf-8", "cp1251", $string);
}
$i = 1;
foreach($result as $row){
    /*$width = explode("J" ,$row["name"]);
    $widthA = explode(" " ,$width[0]);
    $fil = end($widthA);
    $fil = str_replace(",", ".", $fil);
    $es = explode("." ,$fil);
    if($es[1] == 0){
        $res = $es[0];
    }else{
        $res = $fil;
    }

    $f = db2array("SELECT id FROM `element_filter` WHERE `id_filter`='26' AND value='$res'");
    if($f) {
        //echo "UPDATE `filter_value` SET `element_value`='$f[id]' WHERE id_product='$row[id]' AND `element_value`='0' AND `id_filter`='26'";
        ///mysql_query("UPDATE `filter_value` SET `element_value`='$f[id]' WHERE id_product='$row[id]' AND `element_value`='0' AND `id_filter`='26'");
        //echo "<br>";
    }*/

    $arr += array($i => array(
        "article" => $row["article"],
        "id" => $row["id"],
        "name" => $row["name"],
        "fil" => "",
    ));
    $i++;
}
/*echo "<pre>";
print_r($arr);
echo "</pre>";*/
$f = fopen('disk_pcd.csv', 'w');
foreach ($arr as $item) {
    fputcsv($f, $item, ';');
}
fclose($f);

$filename = "disk_pcd.csv";
// нужен для Internet Explorer, иначе Content-Disposition игнорируется
if(ini_get('zlib.output_compression'))
    ini_set('zlib.output_compression', 'Off');

$file_extension = strtolower(substr(strrchr($filename,"."),1));
if( $filename == "" )
{
    echo "ОШИБКА: не указано имя файла.";
    exit;
} elseif ( ! file_exists( $filename ) ) // проверяем существует ли указанный файл
{
    echo "ОШИБКА: данного файла не существует.";
    exit;
};
switch( $file_extension )

{ 		//case "csv": $ctype="csv"; break;
    case "html": $ctype="application/html"; break;
    default: $ctype="application/force-download";
}
header("Pragma: public");
header("Expires: 0");
header("Cache-Control: must-revalidate, post-check=0, pre-check=0");
header("Cache-Control: private",false); // нужен для некоторых браузеров
header("Content-Type: $ctype");
header("Content-Disposition: attachment; filename=\"".basename($filename)."\";" );
header("Content-Transfer-Encoding: binary");
//header("Content-Length: ".filesize($filename)); // необходимо доделать подсчет размера файла по абсолютному пути
readfile("$filename");
exit();

/*$array = array('87093' =>'15','87091' =>'16','87085' =>'17','87013' =>'20','87062' =>'16','87084' =>'17','87088' =>'16','87014' =>'20','87064' =>'16','87063' =>'17','87007' =>'15c','87060' =>'13c','87021' =>'21','87015' =>'19','87010' =>'14','87011' =>'18','86983' =>'17','87000' =>'16','87008' =>'14','87009' =>'14','86971' =>'16','86979' =>'15','87020' =>'16','87055' =>'16','87016' =>'20','87012' =>'17','86985' =>'16','86980' =>'19','86987' =>'17','86975' =>'17','87001' =>'18','87053' =>'17','87044' =>'16','87061' =>'16','87003' =>'16','86981' =>'18','87056' =>'15','86996' =>'19','87059' =>'16c','87083' =>'20','86977' =>'21','87026' =>'18','86995' =>'18','87002' =>'19','86976' =>'20','87043' =>'19','87029' =>'18','87004' =>'18','87082' =>'20','87079' =>'20','87019' =>'16c','86963' =>'15','86997' =>'20','87052' =>'17','86964' =>'13','86968' =>'17','87028' =>'20','87045' =>'19','87050' =>'15','87080' =>'20','87005' =>'15','87041' =>'13','87049' =>'16','87017' =>'15','87018' =>'15','87022' =>'20','87081' =>'19','87078' =>'15','86966' =>'18','86972' =>'17','87025' =>'16c','87070' =>'16','87054' =>'18','86982' =>'14','87058' =>'19','86988' =>'19','86990' =>'16c','86978' =>'16','87057' =>'17','86991' =>'14','86993' =>'15','87051' =>'16','87048' =>'17','87071' =>'15','86999' =>'18','86974' =>'16','86965' =>'15','86998' =>'16','86970' =>'20','87077' =>'17','87024' =>'17','87032' =>'15','86989' =>'16','87023' =>'20','87030' =>'17','87046' =>'16','87076' =>'15','87031' =>'18','86967' =>'18','87069' =>'17','86992' =>'15','87039' =>'14c','87033' =>'20','87068' =>'17','87047' =>'19','87034' =>'17','86994' =>'13','87074' =>'17','86973' =>'17','87036' =>'17','87035' =>'19','87073' =>'16','87087' =>'16','87086' =>'15','87072' =>'16','87067' =>'17','87092' =>'16','87089' =>'17','87066' =>'18','87065' =>'18','87040' =>'15','86984' =>'17','87037' =>'20','87027' =>'17','87075' =>'18','87042' =>'20','86969' =>'18','86986' =>'18','87038' =>'18','87090' =>'18','87006' =>'19','81834' =>'16','81833' =>'15','81832' =>'15','81835' =>'16','81836' =>'16','81839' =>'17','81838' =>'16','81837' =>'16','81841' =>'17','81840' =>'17','81844' =>'18','81843' =>'17','81842' =>'17','81845' =>'18','81846' =>'18','81848' =>'18','81847' =>'18','81850' =>'20','81849' =>'18','81853' =>'21','81852' =>'17','81851' =>'19','81855' =>'22','81854' =>'20','81856' =>'16','81858' =>'18','81857' =>'17','81859' =>'20','81861' =>'16','81860' =>'20','81863' =>'17','81862' =>'20','81865' =>'18','81864' =>'20','81868' =>'15','81867' =>'14','81866' =>'14','81869' =>'15','81870' =>'15','81873' =>'16','81872' =>'15','81871' =>'16','81875' =>'17','81874' =>'17','81877' =>'17','81876' =>'16','81878' =>'14','81880' =>'16','81879' =>'17','81882' =>'19','81881' =>'18','81884' =>'15','81883' =>'17','81886' =>'16','81885' =>'16','81887' =>'17','81889' =>'17','81888' =>'17','81891' =>'18','81890' =>'17','81894' =>'17','81893' =>'16','81892' =>'16','81895' =>'17','81898' =>'17','81897' =>'14','81896' =>'15','81901' =>'17','81900' =>'16','81899' =>'17','81903' =>'17','81902' =>'18','81904' =>'16','81908' =>'19','81907' =>'17','81906' =>'17','81905' =>'15','81911' =>'18','81910' =>'20','81909' =>'18','81913' =>'18','81912' =>'20','81916' =>'15','81915' =>'18','81914' =>'19','81920' =>'15','81919' =>'18','81918' =>'20','81917' =>'19','81922' =>'15','81921' =>'16','81923' =>'17','81926' =>'18','81925' =>'18','81924' =>'17','81929' =>'20','81928' =>'18','81927' =>'18','81931' =>'20','81930' =>'17','81932' =>'20','81935' =>'15','81934' =>'14','81933' =>'14','81938' =>'16','81937' =>'16','81936' =>'16','81940' =>'18','81939' =>'17','81941' =>'17','81944' =>'18','81943' =>'19','81942' =>'17','81947' =>'17','81946' =>'17','81945' =>'16','81949' =>'14','81948' =>'17','81951' =>'15','81950' =>'17','81954' =>'18','81953' =>'18','81952' =>'15','81957' =>'18','81956' =>'15','81955' =>'18','82077' =>'16','82079' =>'16','82078' =>'16','82081' =>'20','82080' =>'18','82084' =>'20','82083' =>'18','82082' =>'18','82582' =>'18','82581' =>'17','82585' =>'19','82584' =>'18','82583' =>'18','82587' =>'17','82586' =>'19','82590' =>'16','82589' =>'16','82588' =>'16','82592' =>'18','82591' =>'17','82595' =>'19','82594' =>'18','82593' =>'17','82597' =>'18','82596' =>'17','82600' =>'18','82599' =>'18','82598' =>'18','82602' =>'17','82601' =>'18','82604' =>'17','82603' =>'17','82607' =>'19','82606' =>'19','82605' =>'19','82609' =>'18','82608' =>'19','82610' =>'19','82612' =>'19','82611' =>'19','82614' =>'20','82613' =>'19','82617' =>'20','82616' =>'19','82615' =>'19','82619' =>'20','82618' =>'20','82620' =>'20','82622' =>'19','82621' =>'19','82624' =>'18','82623' =>'17','82627' =>'18','82626' =>'19','82625' =>'18','82629' =>'19','82628' =>'19','82630' =>'19','82631' =>'20','82634' =>'17','82633' =>'17','82632' =>'20','82636' =>'21','82635' =>'18','82638' =>'21','82637' =>'21','82640' =>'19','82639' =>'21','82642' =>'19','82641' =>'18','82645' =>'20','82644' =>'20','82643' =>'20','82646' =>'20','82647' =>'20','82648' =>'22','82649' =>'15','82650' =>'15','82651' =>'16','82652' =>'16','82653' =>'16','82654' =>'16','82655' =>'17','82656' =>'17','82657' =>'18','82658' =>'18','82659' =>'18','82660' =>'18','82661' =>'15','82662' =>'15','82663' =>'16','82664' =>'17','82665' =>'18','82666' =>'18','82667' =>'18','82668' =>'19','82669' =>'19','82670' =>'19','82671' =>'20','82672' =>'16','82673' =>'20','82674' =>'20','82675' =>'19','82676' =>'20','82677' =>'20','82678' =>'19','82679' =>'15','82680' =>'16','82681' =>'15','82682' =>'17','82683' =>'19','82684' =>'19','82687' =>'14','82688' =>'14','82689' =>'14','82690' =>'15','82691' =>'14','82692' =>'15','82693' =>'15','82694' =>'17','82695' =>'15','82696' =>'16','82697' =>'15','82698' =>'17','82699' =>'17','82700' =>'17','82701' =>'17','82702' =>'16','82703' =>'15','82704' =>'18','82705' =>'17','82706' =>'18','82707' =>'17','82708' =>'18','83623' =>'16c','83624' =>'16c','83625' =>'15c','83626' =>'16c','83627' =>'16c','83628' =>'16c','83629' =>'14c','83658' =>'17','83657' =>'16','83659' =>'18','83660' =>'15','83663' =>'16','83662' =>'15','83661' =>'15','83666' =>'16','83665' =>'16','83664' =>'16','83668' =>'17','83667' =>'16','83669' =>'15','83671' =>'17','83670' =>'17','83673' =>'18','83672' =>'18','83970' =>'15','83969' =>'14','83971' =>'15','83973' =>'16','83972' =>'15','83974' =>'16','83976' =>'16','83977' =>'16','83975' =>'16','83978' =>'16','83979' =>'16','83980' =>'17','83981' =>'17','83982' =>'17','83983' =>'17','83984' =>'17','83985' =>'17','83986' =>'17','83987' =>'17','83988' =>'17','83989' =>'17','83990' =>'18','83991' =>'18','83994' =>'18','83993' =>'18','83992' =>'18','83995' =>'18','83997' =>'19','83996' =>'18','84000' =>'19','83999' =>'19','83998' =>'19','84002' =>'20','84001' =>'19','84004' =>'20','84003' =>'20','84007' =>'17','84006' =>'17','84005' =>'16','84148' =>'17','84147' =>'17','84150' =>'18','84149' =>'17','84152' =>'16','84151' =>'19','84154' =>'17','84153' =>'16','84157' =>'16','84156' =>'17','84155' =>'17','84159' =>'18','84158' =>'17','84160' =>'18','84161' =>'19','84163' =>'20','84162' =>'19','84165' =>'20','84164' =>'20','84168' =>'20','84167' =>'20','84166' =>'20','84170' =>'21','84169' =>'20','84172' =>'17','84171' =>'18','84174' =>'18','84173' =>'17','84176' =>'18','84175' =>'18','84178' =>'19','84177' =>'19','84180' =>'17','84179' =>'18','84181' =>'21','84183' =>'18','84182' =>'21','84185' =>'20','84184' =>'19','84187' =>'20','84186' =>'20','84190' =>'16','84189' =>'16','84188' =>'21','84192' =>'17','84191' =>'17','84194' =>'17','84193' =>'17','84196' =>'17','84195' =>'17','84198' =>'17','84197' =>'17','84200' =>'18','84199' =>'17','84202' =>'18','84201' =>'18','84204' =>'18','84203' =>'18','84207' =>'18','84206' =>'18','84205' =>'18','84209' =>'19','84208' =>'18','84210' =>'19','84211' =>'19','84212' =>'20','84214' =>'20','84213' =>'20','84216' =>'20','84215' =>'20','84218' =>'20','84217' =>'20','84220' =>'20','84219' =>'20','84222' =>'20','84221' =>'20','84223' =>'20','84224' =>'21','84226' =>'21','84225' =>'21','84229' =>'18','84228' =>'21','84227' =>'21','84231' =>'21','84230' =>'21','84233' =>'21','84232' =>'20','84235' =>'19','84234' =>'20','84237' =>'18','84236' =>'22','85542' =>'18','85543' =>'18','85544' =>'17','85545' =>'20','85546' =>'17','85547' =>'17','85548' =>'18','85549' =>'19','85550' =>'18','85551' =>'19','85552' =>'18','85553' =>'19','85554' =>'20','86046' =>'19','86047' =>'19','86048' =>'19','86049' =>'18','86050' =>'19','86051' =>'19','86052' =>'18','86053' =>'18','86054' =>'17','86055' =>'20','86056' =>'20','86057' =>'17','86058' =>'20','86774' =>'17','86775' =>'16','86776' =>'17','86777' =>'18','86778' =>'18','86779' =>'17','86780' =>'18','86781' =>'18','86782' =>'17','86783' =>'17','86784' =>'18','86785' =>'16','86786' =>'18','86789' =>'19','86790' =>'17','86791' =>'17','86792' =>'17','86793' =>'17','86794' =>'17','86795' =>'17','86796' =>'18','86797' =>'18','86798' =>'18','86799' =>'18','87094' =>'16','87095' =>'17','87096' =>'17','87097' =>'17','87098' =>'18','87099' =>'15','87100' =>'16','87101' =>'17','87102' =>'17','87103' =>'18','87104' =>'19','87105' =>'20','87106' =>'20','87107' =>'20','87108' =>'16c','87109' =>'17','87110' =>'17','87169' =>'15','87170' =>'18','87171' =>'16','87172' =>'17','87173' =>'15','87174' =>'20','87175' =>'21','87176' =>'15','87177' =>'18','87178' =>'15','87179' =>'15','87180' =>'20','87181' =>'17','87182' =>'16','87183' =>'14c','87184' =>'17','87185' =>'16','87186' =>'18','87187' =>'18','87188' =>'20','87189' =>'18','87190' =>'18','87191' =>'18','87192' =>'16c','87193' =>'16c','87194' =>'18','87195' =>'18','87196' =>'19','87197' =>'18','87198' =>'18','87199' =>'18','87200' =>'16c','87201' =>'17','87202' =>'17','87203' =>'17','87204' =>'16','87205' =>'17','87206' =>'17','87207' =>'16','87208' =>'18','87209' =>'16','87210' =>'20','87211' =>'19','87212' =>'20','87213' =>'16','87214' =>'17','87299' =>'17','87300' =>'15','87301' =>'16','87302' =>'17','87303' =>'16','87304' =>'16','87305' =>'16c','87306' =>'16c','87307' =>'17','87308' =>'16','87309' =>'20','87310' =>'19','87311' =>'17','87312' =>'16','87313' =>'20','87314' =>'16','87315' =>'15','87316' =>'16','87317' =>'16','87318' =>'18','87319' =>'19','87320' =>'19','87321' =>'20','87322' =>'20','87323' =>'20','87324' =>'18','87325' =>'17','87326' =>'18','87327' =>'15','87328' =>'21','87329' =>'14','87330' =>'18','87331' =>'18','87332' =>'21','87333' =>'16','87334' =>'18','87335' =>'18','87336' =>'17','87337' =>'17','87338' =>'15','87339' =>'18','87340' =>'21','87341' =>'18','87342' =>'18','87343' =>'20','87344' =>'20','87345' =>'17','87346' =>'17','87347' =>'17','87348' =>'15','87349' =>'16','87350' =>'16','87351' =>'17','87352' =>'17','87353' =>'20','87354' =>'19','87355' =>'20','87356' =>'18','87357' =>'14','87358' =>'17','87359' =>'16','87360' =>'15','87361' =>'19','87362' =>'19','87363' =>'20','87364' =>'19','87365' =>'19','87366' =>'15','87367' =>'19','87368' =>'16','87369' =>'18','87370' =>'18','87371' =>'19','87372' =>'19','87373' =>'15','87374' =>'14','87375' =>'15','87376' =>'14','87377' =>'14','87378' =>'14','87379' =>'14','87380' =>'15','87381' =>'15','87382' =>'13','87383' =>'16');
//$result = db2array("SELECT t1.element_value, t1.id_product FROM filter_value as t1 WHERE t1.element_value!='0' AND t1.id_filter='21' AND t1.id_product IN () ", 2);


echo "<pre>";
print_r($array);
echo "</pre>";

foreach ($array as $key=>$item){
    $temp = db2array("SELECT id FROM `element_filter` WHERE `id_filter`='20' AND value='$item'");
    echo "UPDATE `filter_value` SET `id_filter`='20',`element_value`='$temp[id]' WHERE id_product='$key'";
    mysql_query("UPDATE `filter_value` SET `id_filter`='20',`element_value`='$temp[id]' WHERE id_product='$key'");
    echo "<br>";
}*/
?>